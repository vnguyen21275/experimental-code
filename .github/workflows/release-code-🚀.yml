name: Release to Production

# Invoke the workflow after the Push Tag workflow has succeeded
on:
  workflow_run:
    workflows: [Bump Version and Push Tag]
    types: [completed]

jobs:
  release_tag:
    name: 'Auto Tagger: Release to Production'
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - uses: actions/checkout@v2.2.0
        with:
          fetch-depth: 0 # Required due to the way Git works; without it, this action won't be able to find any of the correct tags
      - name: Get Latest Tag
        id: latest_tag
        uses: WyriHaximus/github-action-get-previous-tag@v1

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release the Latest Tag
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.latest_tag.outputs.tag }}
          release_name: ${{ steps.latest_tag.outputs.tag }} Wacky Woohoo Pizza Time!!@! üçïüöÄ
          body: ${{steps.build_changelog.outputs.changelog}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
